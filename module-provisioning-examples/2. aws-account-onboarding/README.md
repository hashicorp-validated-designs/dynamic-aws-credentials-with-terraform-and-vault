# AWS Account Onboarding Example

This example demonstrates how to onboard AWS accounts to HashiCorp Vault for dynamic credential generation. It utilizes the `terraform-vault-aws-account-onboarding` module to configure the necessary resources in AWS and Vault.

## Enabling Dynamic Credentials

This example focuses on setting up the core components required for Vault to dynamically generate AWS credentials:

### IAM Role for Vault

* An IAM role is created in each AWS account that you want to manage with Vault. This role acts as a "service account" for Vault, allowing it to generate temporary AWS credentials.
* The role is configured with a trust policy that explicitly permits the Vault service user (created in the prerequisites example) to assume it. This ensures that only Vault can use this role to generate credentials.

### IAM Role Policy

* Each IAM role is associated with a policy that defines the maximum set of permissions that any temporary credentials generated by Vault can have. This policy acts as a safeguard, preventing even Vault from generating credentials with excessive permissions.
* This policy can be a built-in AWS managed policy (like `AdministratorAccess` or `AmazonS3ReadOnlyAccess`) or a custom policy defined in a JSON file.

### Vault AWS Secret Backend Roles

* For each AWS account, corresponding roles are created within the Vault AWS secret backend. These roles define the specific configurations for generating dynamic credentials.
* Each role can be configured with different parameters, such as the IAM role to assume, the TTL (time-to-live) for the credentials, and any additional policy constraints.

### Vault Role Policies

* Each Vault role can have an associated policy that acts as an additional filter on the permissions granted to the temporary credentials. This allows for fine-grained control over the actions and resources that the credentials can access.
* This policy can be a custom policy defined in a JSON document or a reference to a built-in AWS managed policy. The final permissions of the credentials are the intersection of the permissions allowed by the IAM role policy and the Vault role policy.

## Custom Policies

This example includes a `policies` directory containing custom JSON policy documents. These documents define fine-grained permissions for specific actions and resources within AWS. The example demonstrates how to use these custom policies when configuring the Vault AWS secret backend roles.

## Data Sourcing

This example leverages Terraform's remote state data source to retrieve information from the prerequisites example. This includes the path to the AWS secrets engine in Vault and the ARN of the Vault service user. This approach promotes modularity and reusability by allowing examples to build upon each other.

## Additional Details

To gain a better understanding of the components please refer to the module's [README](../../modules/terraform-vault-aws-account-onboarding/README.md)

<!-- BEGIN_TF_DOCS -->

### Providers

| Name | Version |
|------|---------|
| terraform | n/a |
### Modules

| Name | Source | Version |
|------|--------|---------|
| aws_vault_account_onboarding_01 | ../../modules/terraform-vault-aws-account-onboarding | n/a |
| aws_vault_account_onboarding_02 | ../../modules/terraform-vault-aws-account-onboarding | n/a |
### Requirements

| Name | Version |
|------|---------|
| terraform | ~> 1.9.8 |
| aws | ~> 5.75.1 |
| vault | ~> 4.4.0 |
### Inputs

| Name | Description | Type | Default |
|------|-------------|------|---------|
| external_id | The external ID that's used to establish trust between the Vault service account and the AWS account. | `string` | n/a |
### Outputs

| Name | Description |
|------|-------------|
| all_vault_aws_roles | The AWS role aliases to be used in the Terraform Cloud Workspace or Project environment variables to support dynamic credentials. |
| vault_aws_roles_01 | The AWS role aliases to be used in the Terraform Cloud Workspace or Project environment variables to support dynamic credentials. |
| vault_aws_roles_02 | The AWS role aliases to be used in the Terraform Cloud Workspace or Project environment variables to support dynamic credentials. |
### Resources

| Name | Type |
|------|------|
| [terraform_remote_state.vault_aws_dynamic_creds_prereqs](https://registry.terraform.io/providers/hashicorp/terraform/latest/docs/data-sources/remote_state) | data source |
<!-- END_TF_DOCS -->
